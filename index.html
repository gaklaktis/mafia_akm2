<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Мафия — Таблица</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 10px; }
    table { border-collapse: collapse; width: 100%; }
    td, th {
      border: 1px solid #ccc;
      text-align: center;
      padding: 5px;
      min-width: 40px;
    }
    .cell { cursor: pointer; }
    .red { background-color: #f88; }
    .green { background-color: #8f8; }
    .purple { background-color: #d8b6ff; }
    .pink { background-color: #ffc0cb; }
    select {
      font-size: 14px;
      padding: 2px;
      width: 100%;
    }
    .legend {
      background: #f0f0f0;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <h3>Таблица ночных действий</h3>
  <div class="legend">
    <strong>Подсказка по ролям:</strong><br>
    Х — мафия, Хд — дон, Л — любовница, В — доктор, Ш — шериф, М — маньяк, К — камикадзе, С — мститель, П — путана
  </div>

  <table id="mafiaTable">
    <thead>
      <tr id="headerRow">
        <th>#</th>
        <th>Роль</th>
        <!-- Ночи -->
      </tr>
    </thead>
    <tbody id="tableBody">
      <!-- Строки -->
    </tbody>
  </table>

  <script>
    const params = new URLSearchParams(window.location.search);
    const countParam = params.get("count");
    const playerCount = (!isNaN(parseInt(countParam)) && parseInt(countParam) >= 1) ? parseInt(countParam) : 10;
    const nightCount = 7;

    const headerRow = document.getElementById("headerRow");
    for (let n = 1; n <= nightCount; n++) {
      const th = document.createElement("th");
      th.textContent = `Ночь ${n}`;
      headerRow.appendChild(th);
    }

    const tableBody = document.getElementById("tableBody");

    const getStrongestColor = (text) => {
      text = text.toUpperCase();
      if (text.includes("Л")) return "purple";
      if (text.includes("В")) return "green";
      if (text.includes("Х") || text.includes("М")) return "red";
      if (text.includes("П")) return "pink";
      return "";
    };

    const roleOptions = ["", "Х", "Хд", "Л", "В", "Ш", "М", "К", "С", "П"];

    for (let i = 1; i <= playerCount; i++) {
      const row = document.createElement("tr");

      // Номер игрока
      const numCell = document.createElement("td");
      numCell.textContent = i;
      row.appendChild(numCell);

      // Выбор роли
      const roleCell = document.createElement("td");
      const select = document.createElement("select");
      roleOptions.forEach(opt => {
        const o = document.createElement("option");
        o.value = opt;
        o.textContent = opt;
        select.appendChild(o);
      });
      roleCell.appendChild(select);
      row.appendChild(roleCell);

      // Ячейки ночей
      for (let night = 1; night <= nightCount; night++) {
        const cell = document.createElement("td");
        cell.className = "cell";
        cell.dataset.row = i;
        cell.dataset.col = `night${night}`;
        cell.textContent = "";
        row.appendChild(cell);
      }

      tableBody.appendChild(row);
    }

    // Обработка клика
    document.addEventListener("click", (e) => {
      if (e.target.classList.contains("cell")) {
        const cell = e.target;
        let input = prompt("Введите действие: Х, М, В, Л, П, К. Чтобы удалить — введите 0");
        if (input === null) return;

        input = input.toUpperCase().trim();

        // Удаление действий
        if (input === "0") {
          cell.textContent = "";
          cell.className = "cell";
          return;
        }

        // Проверка допустимого символа
        if (!/^[ХМВЛПК]$/.test(input)) return;

        const previous = cell.textContent;
        const updated = previous ? previous + "\\" + input : input;
        cell.textContent = updated;

        // Сброс цвета
        cell.className = "cell";
        const color = getStrongestColor(updated);
        if (color) cell.classList.add(color);
      }
    });
  </script>
</body>
</html>
