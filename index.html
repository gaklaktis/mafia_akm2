<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>–ú–∞—Ñ–∏—è ‚Äî –¢–∞–±–ª–∏—Ü–∞</title>
  <style>
    body { font-family: sans-serif; margin:0; padding:10px; background:white; }
    table { border-collapse: collapse; width:100%; }
    td, th { border:1px solid #ccc; text-align:center; padding:5px; min-width:40px; }
    .cell { cursor:pointer; }
    .red { background-color:#f88!important; }
    .green { background-color:#8f8!important; }
    .purple { background-color:#d8b6ff!important; }
    .pink { background-color:#ffc0cb!important; }
    .gradient-pink-purple { background: linear-gradient(45deg,#ffc0cb 50%,#d8b6ff 50%); }
    .gradient-pink-red { background: linear-gradient(45deg,#ffc0cb 50%,#f88 50%); }
    .gradient-pink-green { background: linear-gradient(45deg,#ffc0cb 50%,#8f8 50%); }
    .num-red { background-color:#f55!important; color:white; font-weight:bold; }
    .full-red-row td { background-color:#f88!important; }
    select { font-size:14px; padding:2px; width:100%; }
    .legend { background:#f0f0f0; padding:10px; margin-bottom:10px; border-radius:8px; }
    #selectedPlayer {
      font-size:390px; text-align:center; margin-top:200px;
      font-weight:bold; color:red;
      padding-top:400px; padding-bottom:600px;
    }
    .actions { margin-bottom:10px; }
    .actions label { display:inline-block; padding:6px 12px;
      background:#eee; border:1px solid #ccc; cursor:pointer;
    }
  </style>
</head>
<body>

  <h3>–¢–∞–±–ª–∏—Ü–∞ –Ω–æ—á–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π</h3>
  <div class="legend">
    <strong>–ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ —Ä–æ–ª—è–º:</strong><br>
    –ü ‚Äî –ø—É—Ç–∞–Ω–∞, –õ ‚Äî –ª—é–±–æ–≤–Ω–∏—Ü–∞, –• ‚Äî –º–∞—Ñ–∏—è, –•–¥ ‚Äî –¥–æ–Ω, –í ‚Äî –¥–æ–∫—Ç–æ—Ä,
    –® ‚Äî —à–µ—Ä–∏—Ñ, –ú ‚Äî –º–∞–Ω—å—è–∫, –ö ‚Äî –∫–∞–º–∏–∫–∞–¥–∑–µ, –° ‚Äî –º—Å—Ç–∏—Ç–µ–ª—å
  </div>

  <div class="actions">
    <button onclick="exportData()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <label>
      üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å
      <input type="file" id="loadFile" accept=".json" onchange="importData(event)" style="display:none;">
    </label>
    <button onclick="resetTable()">‚ôªÔ∏è –°–±—Ä–æ—Å</button>
  </div>

  <table id="mafiaTable">
    <thead><tr id="headerRow"><th>#</th><th>–†–æ–ª—å</th></tr></thead>
    <tbody id="tableBody"></tbody>
  </table>

  <div id="selectedPlayer"></div>

  <script>
    const params = new URLSearchParams(location.search);
    const playerCount = parseInt(params.get("count")) || 10;
    const nightCount = 9;
    const roleOptions = ["", "–ü","–õ","–•","–•–¥","–í","–®","–ú","–ö","–°"];
    const headerRow = document.getElementById("headerRow");
    const tableBody = document.getElementById("tableBody");

    for(let n=1; n<=nightCount; n++){
      const th = document.createElement("th");
      th.textContent = `–ù–æ—á—å ${n}`;
      headerRow.appendChild(th);
    }

    function getCellClass(text) {
      const t = text.toUpperCase();
      if(t.includes("–•–•–•")) return "red";
      if(t.includes("–ü") && t.includes("–õ")) return "gradient-pink-purple";
      if(t.includes("–ü") && t.includes("–í")) return "gradient-pink-green";
      if(t.includes("–ü") && (t.includes("–•")||t.includes("–ú"))) return "gradient-pink-red";
      if(t.includes("–õ")) return "purple";
      if(t.includes("–í")) return "green";
      if(t.includes("–•")||t.includes("–ú")) return "red";
      if(t.includes("–ü")) return "pink";
      return "";
    }

    function updateRowHighlight(row){
      const cells = [...row.querySelectorAll(".cell")];
      let redFound=false, cancelFound=false;
      let lastCancelIdx=-1;

      cells.forEach((cell,i)=>{
        const cls = getCellClass(cell.textContent);
        if(["green","purple","gradient-pink-green"].includes(cls)) cancelFound=true, lastCancelIdx=i;
      });
      cells.forEach((cell,i)=>{
        if( (cell.textContent.toUpperCase().includes("–•")||cell.textContent.toUpperCase().includes("–ú")) ){
          if(i>lastCancelIdx) redFound=true;
        }
      });

      row.classList.toggle("full-red-row", redFound);
    }

    function updateNumberColor(row){
      const cells=[...row.querySelectorAll(".cell")];
      const numCell = row.querySelector(".number-cell");
      let hasRed=false, hasCancel=false;

      cells.forEach(cell=>{
        const cls=getCellClass(cell.textContent);
        if(["green","purple","gradient-pink-green"].includes(cls)) hasCancel=true;
        if(["red","gradient-pink-red"].includes(cls) || cell.textContent.toUpperCase().includes("–•–•–•")) hasRed=true;
      });

      numCell.classList.toggle("num-red", hasRed&&!hasCancel);
    }

    function createTable(count){
      tableBody.innerHTML="";
      for(let i=1;i<=count;i++){
        const r=document.createElement("tr");
        const numCell=document.createElement("td");
        numCell.className="number-cell"; numCell.style.cursor="pointer";
        numCell.textContent=i;
        numCell.onclick=()=>{ document.getElementById("selectedPlayer").textContent=i; };
        r.appendChild(numCell);

        const rc=document.createElement("td");
        const sel=document.createElement("select");
        roleOptions.forEach(o=>{
          const opt=document.createElement("option");
          opt.value=o; opt.textContent=o;
          sel.appendChild(opt);
        });
        rc.appendChild(sel);
        r.appendChild(rc);

        for(let n=1;n<=nightCount;n++){
          const c=document.createElement("td");
          c.className="cell"; c.dataset.row=i; c.dataset.col=`night${n}`; c.textContent="";
          r.appendChild(c);
        }
        tableBody.appendChild(r);
      }
    }

    createTable(playerCount);

    document.onclick = e => {
      if(e.target.classList.contains("cell")){
        const cell=e.target,
              row=cell.parentElement;
        let input=prompt("–í–≤–µ–¥–∏—Ç–µ: –•,–ú,–í,–õ,–ü,–ö,–®,–•–•–•. –£–¥–∞–ª–∏—Ç—å‚Äî0, –ø–æ—Å–ª–µ–¥–Ω–µ–µ‚Äî00");
        if(input===null)return;
        input=input.toUpperCase().trim();
        if(input==="0"){
          cell.textContent=""; cell.className="cell";
        } else if(input==="00"){
          const parts=cell.textContent.split("\\");
          parts.pop();
          cell.textContent=parts.join("\\");
          cell.className="cell";
        } else if(!/^(–•|–ú|–í|–õ|–ü|–ö|–®|–•–•–•)$/.test(input)){
          return;
        } else {
          cell.textContent = cell.textContent ? cell.textContent + "\\" + input : input;
        }
        cell.className="cell";
        const cl=getCellClass(cell.textContent);
        if(cl) cell.classList.add(cl);
        updateRowHighlight(row);
        updateNumberColor(row);
      }
    };

    function exportData(){
      const data={count:playerCount,rows:[]};
      document.querySelectorAll("#tableBody tr").forEach(r=>{
        const tds=r.querySelectorAll("td");
        const number=parseInt(tds[0].textContent);
        const role=tds[1].querySelector("select").value;
        const nights=Array.from(tds).slice(2).map(c=>c.textContent);
        data.rows.push({number,role,nights});
      });
      localStorage.setItem("mafia_table",JSON.stringify(data));
      const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      const link=document.createElement("a");
      const now=new Date();
      const date=now.toISOString().split("T")[0];
      const time=`${String(now.getHours()).padStart(2,'0')}-${String(now.getMinutes()).padStart(2,'0')}`;
      link.href=URL.createObjectURL(blob);
      link.download=`mafia_akm_${date}_${time}.json`;
      link.click();
    }

    function importData(e){
      const f=e.target.files[0];
      if(!f)return;
      const reader=new FileReader();
      reader.onload=ev=>{
        const data=JSON.parse(ev.target.result);
        createTable(data.count);
        data.rows.forEach((r,idx)=>{
          const tr=tableBody.children[idx];
          tr.querySelector("select").value=r.role;
          r.nights.forEach((val,i)=>{
            const c=tr.querySelectorAll(".cell")[i];
            c.textContent=val;
            c.className="cell";
            const cl=getCellClass(val);
            if(cl) c.classList.add(cl);
          });
          updateRowHighlight(tr);
          updateNumberColor(tr);
        });
      };
      reader.readAsText(f);
    }

    function resetTable(){
      if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é —Ç–∞–±–ª–∏—Ü—É?")){
        localStorage.removeItem("mafia_table");
        createTable(playerCount);
      }
    }

    window.addEventListener("beforeunload",exportData);
    window.addEventListener("DOMContentLoaded",()=>{
      const saved=localStorage.getItem("mafia_table");
      if(saved){
        importData({target:{files:[new Blob([saved],{type:'application/json'})]}});
      }
    });
  </script>
</body>
</html>
