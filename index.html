<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Мафия — Таблица</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 10px; background: white; }
    table { border-collapse: collapse; width: 100%; }
    td, th {
      border: 1px solid #ccc;
      text-align: center;
      padding: 5px;
      min-width: 40px;
    }
    .cell { cursor: pointer; }
    .red { background-color: #f88 !important; }
    .green { background-color: #8f8 !important; }
    .purple { background-color: #d8b6ff !important; }
    .pink { background-color: #ffc0cb !important; }
    .gradient-pink-purple { background: linear-gradient(45deg, #ffc0cb 50%, #d8b6ff 50%); }
    .gradient-pink-red { background: linear-gradient(45deg, #ffc0cb 50%, #f88 50%); }
    .gradient-pink-green { background: linear-gradient(45deg, #ffc0cb 50%, #8f8 50%); }
    .num-red { background-color: #f55 !important; color: white; font-weight: bold; }
    .full-red-row td { background-color: #f88 !important; }
    select {
      font-size: 14px;
      padding: 2px;
      width: 100%;
    }
    .legend {
      background: #f0f0f0;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 8px;
    }
    #selectedPlayer {
      font-size: 390px;
      text-align: center;
      margin-top: 100px;
      font-weight: bold;
      color: red;
      padding-top: 400px;
      padding-bottom: 600px;
    }
  </style>
</head>
<body>
  <h3>Таблица ночных действий</h3>
  <div class="legend">
    <strong>Подсказка по ролям:</strong><br />
    П — путана, Л — любовница, Х — мафия, Хд — дон, В — доктор, Ш — шериф, М — маньяк, К — камикадзе, С — мститель
  </div>

  <table id="mafiaTable">
    <thead>
      <tr id="headerRow">
        <th>#</th>
        <th>Роль</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <div id="selectedPlayer"></div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const countParam = params.get("count");
    const playerCount = (!isNaN(parseInt(countParam)) && parseInt(countParam) >= 1) ? parseInt(countParam) : 10;
    const nightCount = 9;

    const headerRow = document.getElementById("headerRow");
    for (let n = 1; n <= nightCount; n++) {
      const th = document.createElement("th");
      th.textContent = `Ночь ${n}`;
      headerRow.appendChild(th);
    }

    const tableBody = document.getElementById("tableBody");
    const roleOptions = ["", "П", "Л", "Х", "Хд", "В", "Ш", "М", "К", "С"];

    function getCellClass(text) {
      const t = text.toUpperCase();

      if (t.includes("ХХХ")) return "red";
      if (t.includes("П") && t.includes("Л")) return "gradient-pink-purple";
      if (t.includes("П") && t.includes("В")) return "gradient-pink-green";
      if (t.includes("П") && (t.includes("Х") || t.includes("М"))) return "gradient-pink-red";
      if (t.includes("Л")) return "purple";
      if (t.includes("В")) return "green";
      if (t.includes("Х") || t.includes("М")) return "red";
      if (t.includes("П")) return "pink";

      return "";
    }

    function updateRowHighlight(row) {
      const cells = row.querySelectorAll(".cell");
      let redFound = false;
      let cancelFound = false;

      cells.forEach(cell => {
        const text = cell.textContent.toUpperCase();
        const className = getCellClass(text);
        if (className === "green" || className === "purple" || className === "gradient-pink-green") cancelFound = true;
        if (className === "red" || className === "gradient-pink-red" || text.includes("ХХХ")) redFound = true;
      });

      if (redFound && !cancelFound) {
        row.classList.add("full-red-row");
      } else {
        row.classList.remove("full-red-row");
      }
    }

    function updateNumberColor(row) {
      const nightCells = Array.from(row.querySelectorAll(".cell"));
      const numCell = row.querySelector(".number-cell");

      let hasRed = false;
      let hasCancel = false;

      for (const cell of nightCells) {
        const text = cell.textContent.toUpperCase();
        const className = getCellClass(text);
        if (className === "green" || className === "purple" || className === "gradient-pink-green") hasCancel = true;
        if (className === "red" || className === "gradient-pink-red" || text.includes("ХХХ")) hasRed = true;
      }

      if (hasRed && !hasCancel) {
        numCell.classList.add("num-red");
      } else {
        numCell.classList.remove("num-red");
      }
    }

    for (let i = 1; i <= playerCount; i++) {
      const row = document.createElement("tr");

      const numCell = document.createElement("td");
      numCell.textContent = i;
      numCell.className = "number-cell";
      numCell.style.cursor = "pointer";
      numCell.addEventListener("click", () => {
        document.getElementById("selectedPlayer").textContent = i;
      });
      row.appendChild(numCell);

      const roleCell = document.createElement("td");
      const select = document.createElement("select");
      roleOptions.forEach(opt => {
        const o = document.createElement("option");
        o.value = opt;
        o.textContent = opt;
        select.appendChild(o);
      });
      roleCell.appendChild(select);
      row.appendChild(roleCell);

      for (let night = 1; night <= nightCount; night++) {
        const cell = document.createElement("td");
        cell.className = "cell";
        cell.dataset.row = i;
        cell.dataset.col = `night${night}`;
        cell.textContent = "";
        row.appendChild(cell);
      }

      tableBody.appendChild(row);
    }

    document.addEventListener("click", (e) => {
      if (e.target.classList.contains("cell")) {
        const cell = e.target;
        let input = prompt("Введите действие: Х, М, В, Л, П, К, Ш, ХХХ. Удалить все — 0, удалить последнее — 00");
        if (input === null) return;

        input = input.toUpperCase().trim();
        const row = cell.parentElement;

        if (input === "0") {
          cell.textContent = "";
          cell.className = "cell";
          updateRowHighlight(row);
          updateNumberColor(row);
          return;
        }

        if (input === "00") {
          const current = cell.textContent;
          if (current.includes("\\")) {
            const parts = current.split("\\");
            parts.pop();
            cell.textContent = parts.join("\\");
          } else {
            cell.textContent = "";
          }
          cell.className = "cell";
          const className = getCellClass(cell.textContent);
          if (className) cell.classList.add(className);
          updateRowHighlight(row);
          updateNumberColor(row);
          return;
        }

        if (!/^(Х|М|В|Л|П|К|Ш|ХХХ)$/.test(input)) return;

        const previous = cell.textContent;
        const updated = previous ? previous + "\\" + input : input;
        cell.textContent = updated;

        cell.className = "cell";
        const className = getCellClass(updated);
        if (className) cell.classList.add(className);

        updateRowHighlight(row);
        updateNumberColor(row);
      }
    });

    // Не перезагружать при возврате на страницу
    document.addEventListener("visibilitychange", () => {
      if (!document.hidden) {
        document.body.style.backgroundColor = "white";
        document.documentElement.style.backgroundColor = "white";
      }
    });
  </script>
</body>
</html>

