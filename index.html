<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>–ú–∞—Ñ–∏—è ‚Äî –¢–∞–±–ª–∏—Ü–∞</title>
  <style>
    body { font-family: sans-serif; padding: 10px; background: white; }
    table { border-collapse: collapse; width: 100%; }
    td, th { border: 1px solid #ccc; padding: 5px; text-align: center; min-width: 40px; }
    .cell { cursor: pointer; }
    .red { background: #f88 !important; }
    .green { background: #8f8 !important; }
    .purple { background: #d8b6ff !important; }
    .pink { background: #ffc0cb !important; }
    .gradient-pink-purple { background: linear-gradient(45deg, #ffc0cb 50%, #d8b6ff 50%); }
    .gradient-pink-green { background: linear-gradient(45deg, #ffc0cb 50%, #8f8 50%); }
    .gradient-pink-red { background: linear-gradient(45deg, #ffc0cb 50%, #f88 50%); }
    .num-red { background: #f55 !important; color: white; font-weight: bold; }
    .full-red-row td { background-color: #f88 !important; }
    #selectedPlayer {
      font-size: 390px;
      text-align: center;
      margin-top: 500px;
      font-weight: bold;
      color: red;
      padding-bottom: 600px;
    }
  </style>
</head>
<body>

<h3>–¢–∞–±–ª–∏—Ü–∞ –Ω–æ—á–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π</h3>
<div style="background: #f0f0f0; padding: 10px; margin-bottom: 10px;">
  <b>–ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ —Ä–æ–ª—è–º:</b><br>
  –ü ‚Äî –ø—É—Ç–∞–Ω–∞, –õ ‚Äî –ª—é–±–æ–≤–Ω–∏—Ü–∞, –• ‚Äî –º–∞—Ñ–∏—è, –•–¥ ‚Äî –¥–æ–Ω, –í ‚Äî –¥–æ–∫—Ç–æ—Ä, –® ‚Äî —à–µ—Ä–∏—Ñ, –ú ‚Äî –º–∞–Ω—å—è–∫, –ö ‚Äî –∫–∞–º–∏–∫–∞–¥–∑–µ, –° ‚Äî –º—Å—Ç–∏—Ç–µ–ª—å
</div>

<div>
  <button onclick="exportData()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <label>üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å
    <input type="file" id="loadFile" style="display:none;" onchange="importData(event)">
  </label>
  <button onclick="resetTable()">‚ôªÔ∏è –°–±—Ä–æ—Å</button>
</div>

<table id="mafiaTable">
  <thead>
    <tr id="headerRow"><th>#</th><th>–†–æ–ª—å</th></tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<div id="selectedPlayer"></div>

<script>
  const playerCount = parseInt(new URLSearchParams(location.search).get("count")) || 10;
  const nightCount = 9;
  const headerRow = document.getElementById("headerRow");
  const tableBody = document.getElementById("tableBody");

  for (let n = 1; n <= nightCount; n++) {
    const th = document.createElement("th");
    th.textContent = `–ù–æ—á—å ${n}`;
    headerRow.appendChild(th);
  }

  const roleOptions = ["", "–ü","–õ","–•","–•–¥","–í","–®","–ú","–ö","–°"];

  function getCellClass(text) {
    const t = text.toUpperCase();
    if (t.includes("–•–•–•")) return "red";
    if (t.includes("–ü") && t.includes("–õ")) return "gradient-pink-purple";
    if (t.includes("–ü") && t.includes("–í")) return "gradient-pink-green";
    if (t.includes("–ü") && (t.includes("–•") || t.includes("–ú"))) return "gradient-pink-red";
    if (t.includes("–õ")) return "purple";
    if (t.includes("–í")) return "green";
    if (t.includes("–•") || t.includes("–ú")) return "red";
    if (t.includes("–ü")) return "pink";
    return "";
  }

  function updateRowHighlight(row) {
    const cells = [...row.querySelectorAll(".cell")];
    let redFlag = false;

    for (let i = 0; i < cells.length; i++) {
      const now = cells[i].textContent.toUpperCase();
      const prev = i > 0 ? cells[i - 1].textContent.toUpperCase() : "";

      if (now.includes("–•–•–•")) {
        redFlag = true;
        break;
      }

      const hasKill = now.includes("–•") || now.includes("–ú");
      const hasCancelNow = now.includes("–õ") || now.includes("–í");
      const hasCancelPrev = prev.includes("–õ") || prev.includes("–í");

      if (hasKill && !hasCancelNow && !hasCancelPrev) {
        redFlag = true;
        break;
      }
    }

    row.classList.toggle("full-red-row", redFlag);
  }

  function updateNumberColor(row) {
    const numberCell = row.querySelector("td");
    const isRed = row.classList.contains("full-red-row");
    numberCell.classList.toggle("num-red", isRed);
  }

  function createTable(count) {
    tableBody.innerHTML = "";
    for (let i = 1; i <= count; i++) {
      const row = document.createElement("tr");

      const numCell = document.createElement("td");
      numCell.className = "number-cell";
      numCell.textContent = i;
      numCell.onclick = () => {
        document.getElementById("selectedPlayer").textContent = i;
      };
      row.appendChild(numCell);

      const roleCell = document.createElement("td");
      const select = document.createElement("select");
      roleOptions.forEach(opt => {
        const o = document.createElement("option");
        o.value = opt;
        o.textContent = opt;
        select.appendChild(o);
      });
      roleCell.appendChild(select);
      row.appendChild(roleCell);

      for (let n = 1; n <= nightCount; n++) {
        const cell = document.createElement("td");
        cell.className = "cell";
        row.appendChild(cell);
      }

      tableBody.appendChild(row);
    }
  }

  createTable(playerCount);

  document.addEventListener("click", e => {
    if (e.target.classList.contains("cell")) {
      const cell = e.target;
      const row = cell.parentElement;
      let input = prompt("–•, –ú, –í, –õ, –ü, –®, –ö, –°, –•–•–•. –£–¥–∞–ª–∏—Ç—å ‚Äî 0. –£–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ ‚Äî 00");
      if (input === null) return;
      input = input.toUpperCase().trim();

      if (input === "0") {
        cell.textContent = "";
      } else if (input === "00") {
        const parts = cell.textContent.split("\\");
        parts.pop();
        cell.textContent = parts.join("\\");
      } else if (/^(–•|–ú|–í|–õ|–ü|–®|–ö|–°|–•–•–•)$/.test(input)) {
        cell.textContent = cell.textContent ? cell.textContent + "\\" + input : input;
      }

      cell.className = "cell";
      const style = getCellClass(cell.textContent);
      if (style) cell.classList.add(style);

      updateRowHighlight(row);
      updateNumberColor(row);
    }
  });

  function exportData() {
    const data = { count: playerCount, rows: [] };
    tableBody.querySelectorAll("tr").forEach(row => {
      const tds = row.querySelectorAll("td");
      const role = tds[1].querySelector("select").value;
      const nights = [...tds].slice(2).map(c => c.textContent);
      data.rows.push({ role, nights });
    });

    const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
    const link = document.createElement("a");
    const now = new Date();
    const date = now.toISOString().split("T")[0];
    const time = `${now.getHours()}-${now.getMinutes()}`;
    link.href = URL.createObjectURL(blob);
    link.download = `mafia_akm_${date}_${time}.json`;
    link.click();
    localStorage.setItem("mafia_table", JSON.stringify(data));
  }

  function importData(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = evt => {
      const data = JSON.parse(evt.target.result);
      createTable(data.count);
      data.rows.forEach((r, i) => {
        const row = tableBody.children[i];
        row.querySelector("select").value = r.role;
        const cells = [...row.querySelectorAll(".cell")];
        r.nights.forEach((val, j) => {
          const c = cells[j];
          c.textContent = val;
          c.className = "cell";
          const style = getCellClass(val);
          if (style) c.classList.add(style);
        });
        updateRowHighlight(row);
        updateNumberColor(row);
      });
    };
    reader.readAsText(file);
  }

  function resetTable() {
    if (confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é —Ç–∞–±–ª–∏—Ü—É?")) {
      localStorage.removeItem("mafia_table");
      createTable(playerCount);
    }
  }

  window.addEventListener("beforeunload", exportData);

  window.addEventListener("DOMContentLoaded", () => {
    const saved = localStorage.getItem("mafia_table");
    if (saved) {
      const data = JSON.parse(saved);
      createTable(data.count);
      data.rows.forEach((r, i) => {
        const row = tableBody.children[i];
        row.querySelector("select").value = r.role;
        const cells = [...row.querySelectorAll(".cell")];
        r.nights.forEach((val, j) => {
          const c = cells[j];
          c.textContent = val;
          c.className = "cell";
          const style = getCellClass(val);
          if (style) c.classList.add(style);
        });
        updateRowHighlight(row);
        updateNumberColor(row);
      });
    }
  });
</script>
</body>
</html>
