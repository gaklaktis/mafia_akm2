<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Мафия — Таблица</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 10px; }
    table { border-collapse: collapse; width: 100%; }
    td, th {
      border: 1px solid #ccc;
      text-align: center;
      padding: 5px;
      min-width: 40px;
    }
    .cell { cursor: pointer; }
    .red { background-color: #f88; }
    .green { background-color: #8f8; }
    .purple { background-color: #d8b6ff; }
    .pink { background-color: #ffc0cb; }
    .num-red { background-color: #f55 !important; color: white; font-weight: bold; }
    select {
      font-size: 14px;
      padding: 2px;
      width: 100%;
    }
    .legend {
      background: #f0f0f0;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 8px;
    }
    #selectedPlayer {
      font-size: 380px;
      text-align: center;
      margin-top: 80px;
      font-weight: bold;
      color: #444;
    }
  </style>
</head>
<body>
  <h3>Таблица ночных действий</h3>
  <div class="legend">
    <strong>Подсказка по ролям:</strong><br>
    П — путана, Л — любовница, Х — мафия, Хд — дон, В — доктор, Ш — шериф, М — маньяк, К — камикадзе, С — мститель
  </div>

  <table id="mafiaTable">
    <thead>
      <tr id="headerRow">
        <th>#</th>
        <th>Роль</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <div id="selectedPlayer"></div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const countParam = params.get("count");
    const playerCount = (!isNaN(parseInt(countParam)) && parseInt(countParam) >= 1) ? parseInt(countParam) : 10;
    const nightCount = 9;

    const headerRow = document.getElementById("headerRow");
    for (let n = 1; n <= nightCount; n++) {
      const th = document.createElement("th");
      th.textContent = `Ночь ${n}`;
      headerRow.appendChild(th);
    }

    const tableBody = document.getElementById("tableBody");
    const roleOptions = ["", "П", "Л", "Х", "Хд", "В", "Ш", "М", "К", "С"];

    const getStrongestColor = (text) => {
      text = text.toUpperCase();
      if (text.includes("Л")) return "purple";
      if (text.includes("В")) return "green";
      if (text.includes("Х") || text.includes("М")) return "red";
      if (text.includes("П")) return "pink";
      return "";
    };

    const updateNumberCellColor = (row) => {
      const nightCells = Array.from(row.querySelectorAll(".cell"));
      const numCell = row.querySelector(".number-cell");
      let finalColor = "";

      for (let cell of nightCells) {
        const text = cell.textContent.toUpperCase();
        const color = getStrongestColor(text);
        if (color === "purple") finalColor = "none";
        else if (color === "green" && finalColor !== "purple") finalColor = "none";
        else if (color === "red" && finalColor === "") finalColor = "red";
      }

      if (finalColor === "red") {
        numCell.classList.add("num-red");
      } else {
        numCell.classList.remove("num-red");
      }
    };

    for (let i = 1; i <= playerCount; i++) {
      const row = document.createElement("tr");

      const numCell = document.createElement("td");
      numCell.textContent = i;
      numCell.className = "number-cell";
      numCell.style.cursor = "pointer";
      numCell.addEventListener("click", () => {
        document.getElementById("selectedPlayer").textContent = i;
      });
      row.appendChild(numCell);

      const roleCell = document.createElement("td");
      const select = document.createElement("select");
      roleOptions.forEach(opt => {
        const o = document.createElement("option");
        o.value = opt;
        o.textContent = opt;
        select.appendChild(o);
      });
      roleCell.appendChild(select);
      row.appendChild(roleCell);

      for (let night = 1; night <= nightCount; night++) {
        const cell = document.createElement("td");
        cell.className = "cell";
        cell.dataset.row = i;
        cell.dataset.col = `night${night}`;
        cell.textContent = "";
        row.appendChild(cell);
      }

      tableBody.appendChild(row);
    }

    document.addEventListener("click", (e) => {
      if (e.target.classList.contains("cell")) {
        const cell = e.target;
        let input = prompt("Введите действие: Х, М, В, Л, П, К, Ш. Удалить все — 0, удалить последнее — 00");
        if (input === null) return;

        input = input.toUpperCase().trim();
        const row = cell.parentElement;

        if (input === "0") {
          cell.textContent = "";
          cell.className = "cell";
          updateNumberCellColor(row);
          return;
        }

        if (input === "00") {
          const current = cell.textContent;
          if (current.includes("\\")) {
            const parts = current.split("\\");
            parts.pop();
            cell.textContent = parts.join("\\");
          } else {
            cell.textContent = "";
          }
          cell.className = "cell";
          const color = getStrongestColor(cell.textContent);
          if (color) cell.classList.add(color);
          updateNumberCellColor(row);
          return;
        }

        if (!/^[ХМВЛПКШ]$/.test(input)) return;

        const previous = cell.textContent;
        const updated = previous ? previous + "\\" + input : input;
        cell.textContent = updated;

        cell.className = "cell";
        const color = getStrongestColor(updated);
        if (color) cell.classList.add(color);

        updateNumberCellColor(row);
      }
    });
  </script>
</body>
</html>


