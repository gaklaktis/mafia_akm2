<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ú–∞—Ñ–∏—è ‚Äî –¢–∞–±–ª–∏—Ü–∞</title>
  <style>
    body { font-family: sans-serif; padding: 10px; }
    table { border-collapse: collapse; width: 100%; }
    td, th {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
      min-width: 40px;
    }
    .cell { cursor: pointer; }
    .red { background: #f88; }
    .green { background: #8f8; }
    .purple { background: #d8b6ff; }
    .pink { background: #ffc0cb; }
    .num-red { background: #f55; color: white; font-weight: bold; }

    .gradient-pink-red {
      background: linear-gradient(135deg, #ffc0cb 50%, #f88 50%);
    }
    .gradient-pink-green {
      background: linear-gradient(135deg, #ffc0cb 50%, #8f8 50%);
    }
    .gradient-pink-purple {
      background: linear-gradient(135deg, #ffc0cb 50%, #d8b6ff 50%);
    }
  </style>
</head>
<body>

<h2>üìã –¢–∞–±–ª–∏—Ü–∞ –¥–µ–π—Å—Ç–≤–∏–π ¬´–ú–∞—Ñ–∏—è¬ª</h2>
<div>
  <b>–ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ —Ä–æ–ª—è–º:</b><br>
  –ü ‚Äî –ø—É—Ç–∞–Ω–∞, –õ ‚Äî –ª—é–±–æ–≤–Ω–∏—Ü–∞, –• ‚Äî –º–∞—Ñ–∏—è, –•–¥ ‚Äî –¥–æ–Ω, –í ‚Äî –¥–æ–∫—Ç–æ—Ä, –® ‚Äî —à–µ—Ä–∏—Ñ, –ú ‚Äî –º–∞–Ω—å—è–∫, –ö ‚Äî –∫–∞–º–∏–∫–∞–¥–∑–µ, –° ‚Äî –º—Å—Ç–∏—Ç–µ–ª—å
</div>
<br>

<table id="mafiaTable">
  <thead>
    <tr id="headerRow">
      <th>‚Ññ</th>
      <th>–†–æ–ª—å</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<div id="selectedPlayer" style="font-size:390px; color:red; text-align:center; margin-top:400px;"></div>

<script>
  const playerCount = parseInt(new URLSearchParams(window.location.search).get("count")) || 10;
  const nightCount = 9;
  const headerRow = document.getElementById("headerRow");
  const tableBody = document.getElementById("tableBody");

  const roleOptions = ["", "–ü","–õ","–•","–•–¥","–í","–®","–ú","–ö","–°"];

  // –î–æ–±–∞–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏ –Ω–æ—á–µ–π
  for (let n = 1; n <= nightCount; n++) {
    const th = document.createElement("th");
    th.textContent = `–ù–æ—á—å ${n}`;
    headerRow.appendChild(th);
  }

  function getCellClass(text) {
    const t = text.toUpperCase();

    if (t.includes("–•–•–•")) return "red";
    const hasP = t.includes("–ü");
    const hasX = t.includes("–•");
    const hasM = t.includes("–ú");
    const hasV = t.includes("–í");
    const hasL = t.includes("–õ");

    if (hasP && (hasX || hasM) && hasV) return "gradient-pink-green";
    if (hasP && (hasX || hasM) && hasL) return "gradient-pink-purple";
    if (hasP && (hasX || hasM)) return "gradient-pink-red";
    if (hasV) return "green";
    if (hasL) return "purple";
    if (hasX || hasM) return "red";
    if (hasP) return "pink";
    return "";
  }

  function updateRowColors(row) {
    const cells = row.querySelectorAll(".cell");
    const numberCell = row.querySelector("td");

    numberCell.classList.remove("num-red");

    for (const cell of cells) {
      const val = cell.textContent.toUpperCase();
      const hasKill = val.includes("–•") || val.includes("–ú") || val.includes("–•–•–•");
      const hasProtection = val.includes("–í") || val.includes("–õ");
      const hasP = val.includes("–ü");

      // –£—Å–ª–æ–≤–∏–µ –¥–ª—è –ø–æ–ª–Ω–æ–π —Å–º–µ—Ä—Ç–∏
      if (val.includes("–•–•–•")) {
        numberCell.classList.add("num-red");
        break;
      }

      if (hasP && (val.includes("–•") || val.includes("–ú")) && !hasProtection) {
        numberCell.classList.add("num-red");
        break;
      }

      if ((val.includes("–•") || val.includes("–ú")) && !hasProtection) {
        numberCell.classList.add("num-red");
        break;
      }
    }
  }

  function createTable() {
    for (let i = 1; i <= playerCount; i++) {
      const row = document.createElement("tr");

      const numCell = document.createElement("td");
      numCell.textContent = i;
      numCell.className = "number-cell";
      numCell.onclick = () => {
        document.getElementById("selectedPlayer").textContent = i;
      };
      row.appendChild(numCell);

      const roleCell = document.createElement("td");
      const select = document.createElement("select");
      roleOptions.forEach(opt => {
        const o = document.createElement("option");
        o.value = opt;
        o.textContent = opt;
        select.appendChild(o);
      });
      roleCell.appendChild(select);
      row.appendChild(roleCell);

      for (let n = 1; n <= nightCount; n++) {
        const cell = document.createElement("td");
        cell.className = "cell";
        row.appendChild(cell);
      }

      tableBody.appendChild(row);
    }
  }

  createTable();

  document.addEventListener("click", e => {
    if (!e.target.classList.contains("cell")) return;
    const cell = e.target;
    const row = cell.parentElement;

    let input = prompt("–í–≤–µ–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏—è (–ø—Ä–∏–º–µ—Ä: –ü, –•, –í, –ú, –õ –∏ —Ç.–ø.).\n–£–¥–∞–ª–∏—Ç—å: 0. –£–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ: 00.");
    if (input === null) return;
    input = input.trim().toUpperCase();

    if (input === "0") {
      cell.textContent = "";
    } else if (input === "00") {
      const parts = cell.textContent.split("\\");
      parts.pop();
      cell.textContent = parts.join("\\");
    } else if (/^(–•|–ú|–í|–õ|–ü|–®|–ö|–°|–•–•–•)$/.test(input)) {
      if (cell.textContent) {
        cell.textContent += "\\" + input;
      } else {
        cell.textContent = input;
      }
    }

    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å—Ç–∏–ª–∏
    cell.className = "cell";
    const style = getCellClass(cell.textContent);
    if (style) cell.classList.add(style);

    updateRowColors(row);
  });
</script>
</body>
</html>
