<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>–ú–∞—Ñ–∏—è ‚Äî –¢–∞–±–ª–∏—Ü–∞</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 10px; background: white; }
    table { border-collapse: collapse; width: 100%; }
    td, th { border: 1px solid #ccc; text-align: center; padding: 5px; min-width: 40px; }
    .cell { cursor: pointer; }
    .red { background-color: #f88 !important; }
    .green { background-color: #8f8 !important; }
    .purple { background-color: #d8b6ff !important; }
    .pink { background-color: #ffc0cb !important; }
    .gradient-pink-purple { background: linear-gradient(45deg, #ffc0cb 50%, #d8b6ff 50%); }
    .gradient-pink-red { background: linear-gradient(45deg, #ffc0cb 50%, #f88 50%); }
    .gradient-pink-green { background: linear-gradient(45deg, #ffc0cb 50%, #8f8 50%); }
    .num-red { background-color: #f55 !important; color: white; font-weight: bold; }
    .full-red-row td { background-color: #f88 !important; }
    select { font-size: 14px; padding: 2px; width: 100%; }
    .legend { background: #f0f0f0; padding: 10px; margin-bottom: 10px; border-radius: 8px; }
    #selectedPlayer { font-size: 390px; text-align: center; margin-top: 100px; font-weight: bold; color: red; padding-top: 400px; padding-bottom: 600px; }
    .actions { margin-bottom: 10px; }
  </style>
</head>
<body>
  <h3>–¢–∞–±–ª–∏—Ü–∞ –Ω–æ—á–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π</h3>
  <div class="legend">
    <strong>–ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ —Ä–æ–ª—è–º:</strong><br />
    –ü ‚Äî –ø—É—Ç–∞–Ω–∞, –õ ‚Äî –ª—é–±–æ–≤–Ω–∏—Ü–∞, –• ‚Äî –º–∞—Ñ–∏—è, –•–¥ ‚Äî –¥–æ–Ω, –í ‚Äî –¥–æ–∫—Ç–æ—Ä, –® ‚Äî —à–µ—Ä–∏—Ñ, –ú ‚Äî –º–∞–Ω—å—è–∫, –ö ‚Äî –∫–∞–º–∏–∫–∞–¥–∑–µ, –° ‚Äî –º—Å—Ç–∏—Ç–µ–ª—å
  </div>

  <div class="actions">
    <button onclick="exportData()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <input type="file" id="loadFile" accept=".json" onchange="importData(event)" />
  </div>

  <table id="mafiaTable">
    <thead>
      <tr id="headerRow">
        <th>#</th>
        <th>–†–æ–ª—å</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <div id="selectedPlayer"></div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const countParam = params.get("count");
    const playerCount = (!isNaN(parseInt(countParam)) && parseInt(countParam) >= 1) ? parseInt(countParam) : 10;
    const nightCount = 9;

    const roleOptions = ["", "–ü", "–õ", "–•", "–•–¥", "–í", "–®", "–ú", "–ö", "–°"];
    const headerRow = document.getElementById("headerRow");
    const tableBody = document.getElementById("tableBody");

    for (let n = 1; n <= nightCount; n++) {
      const th = document.createElement("th");
      th.textContent = `–ù–æ—á—å ${n}`;
      headerRow.appendChild(th);
    }

    function getCellClass(text) {
      const t = text.toUpperCase();
      if (t.includes("–•–•–•")) return "red";
      if (t.includes("–ü") && t.includes("–õ")) return "gradient-pink-purple";
      if (t.includes("–ü") && t.includes("–í")) return "gradient-pink-green";
      if (t.includes("–ü") && (t.includes("–•") || t.includes("–ú"))) return "gradient-pink-red";
      if (t.includes("–õ")) return "purple";
      if (t.includes("–í")) return "green";
      if (t.includes("–•") || t.includes("–ú")) return "red";
      if (t.includes("–ü")) return "pink";
      return "";
    }

    function updateRowHighlight(row) {
      const cells = row.querySelectorAll(".cell");
      let redFound = false;
      let cancelFound = false;

      cells.forEach(cell => {
        const text = cell.textContent.toUpperCase();
        const className = getCellClass(text);
        if (["green", "purple", "gradient-pink-green"].includes(className)) cancelFound = true;
        if (["red", "gradient-pink-red"].includes(className) || text.includes("–•–•–•")) redFound = true;
      });

      if (redFound && !cancelFound) {
        row.classList.add("full-red-row");
      } else {
        row.classList.remove("full-red-row");
      }
    }

    function updateNumberColor(row) {
      const nightCells = Array.from(row.querySelectorAll(".cell"));
      const numCell = row.querySelector(".number-cell");
      let hasRed = false;
      let hasCancel = false;

      for (const cell of nightCells) {
        const text = cell.textContent.toUpperCase();
        const className = getCellClass(text);
        if (["green", "purple", "gradient-pink-green"].includes(className)) hasCancel = true;
        if (["red", "gradient-pink-red"].includes(className) || text.includes("–•–•–•")) hasRed = true;
      }

      if (hasRed && !hasCancel) {
        numCell.classList.add("num-red");
      } else {
        numCell.classList.remove("num-red");
      }
    }

    function createTable(count) {
      tableBody.innerHTML = "";
      for (let i = 1; i <= count; i++) {
        const row = document.createElement("tr");
        const numCell = document.createElement("td");
        numCell.textContent = i;
        numCell.className = "number-cell";
        numCell.style.cursor = "pointer";
        numCell.addEventListener("click", () => {
          document.getElementById("selectedPlayer").textContent = i;
        });
        row.appendChild(numCell);

        const roleCell = document.createElement("td");
        const select = document.createElement("select");
        roleOptions.forEach(opt => {
          const o = document.createElement("option");
          o.value = opt;
          o.textContent = opt;
          select.appendChild(o);
        });
        roleCell.appendChild(select);
        row.appendChild(roleCell);

        for (let night = 1; night <= nightCount; night++) {
          const cell = document.createElement("td");
          cell.className = "cell";
          cell.dataset.row = i;
          cell.dataset.col = `night${night}`;
          cell.textContent = "";
          row.appendChild(cell);
        }
        tableBody.appendChild(row);
      }
    }

    createTable(playerCount);

    document.addEventListener("click", (e) => {
      if (e.target.classList.contains("cell")) {
        const cell = e.target;
        let input = prompt("–í–≤–µ–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ: –•, –ú, –í, –õ, –ü, –ö, –®, –•–•–•. –£–¥–∞–ª–∏—Ç—å –≤—Å–µ ‚Äî 0, —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ ‚Äî 00");
        if (input === null) return;
        input = input.toUpperCase().trim();
        const row = cell.parentElement;

        if (input === "0") {
          cell.textContent = "";
          cell.className = "cell";
          updateRowHighlight(row);
          updateNumberColor(row);
          return;
        }
        if (input === "00") {
          const current = cell.textContent;
          if (current.includes("\\")) {
            const parts = current.split("\\");
            parts.pop();
            cell.textContent = parts.join("\\");
          } else {
            cell.textContent = "";
          }
          cell.className = "cell";
          const className = getCellClass(cell.textContent);
          if (className) cell.classList.add(className);
          updateRowHighlight(row);
          updateNumberColor(row);
          return;
        }
        if (!/^(–•|–ú|–í|–õ|–ü|–ö|–®|–•–•–•)$/.test(input)) return;

        const previous = cell.textContent;
        const updated = previous ? previous + "\\" + input : input;
        cell.textContent = updated;
        cell.className = "cell";
        const className = getCellClass(updated);
        if (className) cell.classList.add(className);
        updateRowHighlight(row);
        updateNumberColor(row);
      }
    });

    function exportData() {
      const data = {
        count: playerCount,
        rows: []
      };
      tableBody.querySelectorAll("tr").forEach((row, idx) => {
        const cells = row.querySelectorAll("td");
        const number = parseInt(cells[0].textContent);
        const role = cells[1].querySelector("select").value;
        const nights = Array.from(cells).slice(2).map(c => c.textContent);
        data.rows.push({ number, role, nights });
      });
      localStorage.setItem("mafia_table", JSON.stringify(data));
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const link = document.createElement("a");
      const date = new Date().toISOString().split("T")[0];
      link.href = URL.createObjectURL(blob);
      link.download = `${date}_mafia_akm_bot.json`;
      link.click();
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const content = JSON.parse(e.target.result);
        createTable(content.count);
        content.rows.forEach((r, idx) => {
          const row = tableBody.children[idx];
          row.querySelector("select").value = r.role;
          const nightCells = row.querySelectorAll(".cell");
          r.nights.forEach((val, i) => {
            const cell = nightCells[i];
            cell.textContent = val;
            cell.className = "cell";
            const className = getCellClass(val);
            if (className) cell.classList.add(className);
          });
          updateRowHighlight(row);
          updateNumberColor(row);
        });
      };
      reader.readAsText(file);
    }

    window.addEventListener("beforeunload", exportData);

    window.addEventListener("DOMContentLoaded", () => {
      const saved = localStorage.getItem("mafia_table");
      if (saved) {
        const content = JSON.parse(saved);
        createTable(content.count);
        content.rows.forEach((r, idx) => {
          const row = tableBody.children[idx];
          row.querySelector("select").value = r.role;
          const nightCells = row.querySelectorAll(".cell");
          r.nights.forEach((val, i) => {
            const cell = nightCells[i];
            cell.textContent = val;
            cell.className = "cell";
            const className = getCellClass(val);
            if (className) cell.classList.add(className);
          });
          updateRowHighlight(row);
          updateNumberColor(row);
        });
      }
    });
  </script>
</body>
</html>

